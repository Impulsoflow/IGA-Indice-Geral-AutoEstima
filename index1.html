<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Avalia√ß√£o N√≠vel de Autoestima ‚Äî Instituto Impulso</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet" />

  <style>
    body{background: linear-gradient(135deg, #f6fdf8, #e9fbf0);font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;}
    .card-soft{background: rgba(255,255,255,.90);border: 1px solid rgba(16,185,129,.14);box-shadow: 0 18px 50px rgba(2,6,23,.07);backdrop-filter: blur(10px);}
    .scale-option{transition: all .14s ease;border: 2px solid #d1d5db;border-radius: 12px;padding: 10px 8px;text-align: center;cursor: pointer;background: linear-gradient(135deg,#ffffff,#f7fee7);font-weight: 700;user-select:none;min-height: 56px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;}
    .scale-option:hover{ background:#f0fdf4; border-color:#34d399; }
    .scale-option:active{ transform: scale(1.03); }
    .scale-option.selected{background: linear-gradient(135deg,#34d399,#10b981);color:#064e3b;border-color:#10b981;}
    .btn-primary{ background: linear-gradient(135deg,#34d399,#10b981); transition: transform .1s ease; }
    .btn-primary:active{ transform: scale(1.01); }
    .btn-secondary{ background: linear-gradient(135deg,#6b7280,#4b5563); }
    .progress-rail{ height:10px; background:#e5e7eb; border-radius:999px; overflow:hidden; }
    .progress-fill{ height:100%; background: linear-gradient(90deg,#34d399,#10b981); transition: width .25s ease; }
    #themesChart{ max-width: 920px !important; height: 360px !important; margin: 0 auto; }
    .sig-ui{font-family: "Dancing Script", cursive;color:#1d4ed8;font-size: 14px;text-align: right;opacity: .9;margin-top: 10px;}

    @media (max-width: 480px){
      .scale-grid{ grid-template-columns: repeat(3, minmax(0, 1fr)) !important; }
      .scale-grid .scale-option:nth-child(4), .scale-grid .scale-option:nth-child(5){grid-column: span 3 / span 3 !important;flex-direction: row;justify-content: center;gap: 10px;min-height: 52px;}
      .scale-grid .scale-option small{ font-size: 11px !important; }
      .question-text{ font-size: 18px !important; line-height: 1.35 !important; }
      .actions-mobile button{ width: 100% !important; }
    }
  </style>
</head>

<body class="min-h-screen flex items-center justify-center p-3 sm:p-4">
  <div class="max-w-3xl w-full card-soft rounded-2xl p-5 sm:p-6 md:p-8">

    <div class="text-center">
      <div class="text-xl sm:text-2xl md:text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-emerald-700 to-green-600">
        Instituto Impulso Coaching de Lideran√ßa
      </div>
      <div class="mt-1 text-sm md:text-base text-emerald-900/70 font-semibold">
        A mudan√ßa pode acontecer em um instante.
      </div>

      <h1 class="mt-4 text-2xl sm:text-3xl md:text-4xl font-extrabold text-gray-900">
        Avalia√ß√£o N√≠vel de Autoestima
      </h1>
    </div>

    <div id="intro" class="mt-6">
      <div class="bg-white/70 border border-emerald-100 rounded-xl p-4">
        <p class="text-sm font-extrabold text-gray-800 mb-3">Dados do participante</p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <input id="name" type="text" placeholder="Nome *" class="border border-emerald-200 rounded-xl p-3 w-full focus:outline-none focus:ring-2 focus:ring-emerald-300 bg-white" />
          <input id="email" type="email" placeholder="Email *" class="border border-emerald-200 rounded-xl p-3 w-full focus:outline-none focus:ring-2 focus:ring-emerald-300 bg-white" />
          <input id="age" type="number" inputmode="numeric" min="1" max="120" placeholder="Idade *" class="border border-emerald-200 rounded-xl p-3 w-full focus:outline-none focus:ring-2 focus:ring-emerald-300 bg-white" />
          <input id="occupation" type="text" placeholder="Profiss√£o *" class="border border-emerald-200 rounded-xl p-3 w-full focus:outline-none focus:ring-2 focus:ring-emerald-300 bg-white" />
        </div>

        <div class="flex justify-end mt-4 actions-mobile">
          <button onclick="startTest()" class="btn-primary text-emerald-950 px-5 py-2.5 rounded-xl shadow-sm font-extrabold">Iniciar</button>
        </div>

        <p class="mt-3 text-xs text-gray-500">
          Observa√ß√£o: ferramenta educativa de desenvolvimento pessoal. Se houver sofrimento emocional intenso, considere apoio profissional qualificado.
        </p>
      </div>
    </div>

    <div id="test" class="hidden mt-6"><div id="questionHost"></div></div>

    <div id="result" class="hidden mt-6">
      <div class="bg-white/70 border border-emerald-100 rounded-xl p-4">
        <p class="text-sm font-extrabold text-gray-800">Resultado</p>
        <p id="personalData" class="text-xs text-gray-600 mt-1"></p>

        <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
          <div class="bg-white rounded-xl border border-gray-100 p-4">
            <p class="text-xs font-extrabold text-gray-500">IGA</p>
            <p id="igaPct" class="text-4xl font-extrabold text-emerald-700">‚Äî%</p>
            <p id="igaLevel" class="text-xs text-gray-600 mt-1">‚Äî</p>
          </div>
          <div class="bg-white rounded-xl border border-gray-100 p-4 md:col-span-2">
            <p class="text-xs font-extrabold text-gray-500">Perfil</p>
            <p id="profileTitle" class="text-lg font-extrabold text-gray-900">‚Äî</p>
            <p id="profileText" class="text-xs text-gray-700 mt-1">‚Äî</p>
          </div>
        </div>

        <div id="alerts" class="mt-4 hidden"></div>

        <div class="mt-4 bg-white rounded-xl border border-gray-100 p-4">
          <p class="text-xs font-extrabold text-gray-500 mb-2">Gr√°fico por temas (m√≥dulos)</p>
          <canvas id="themesChart"></canvas>
          <p class="text-[11px] text-gray-500 mt-2">Refer√™ncia: m√≠nimo saud√°vel = <span class="font-bold" id="minHealthyLabel">‚Äî</span>.</p>
        </div>

        <div class="mt-4 bg-white rounded-xl border border-gray-100 p-4">
          <p class="text-xs font-extrabold text-gray-500 mb-2">Explica√ß√£o detalhada por m√≥dulo</p>
          <div id="moduleExplain" class="space-y-3"></div>
        </div>

        <div id="mailtoFallbackHost" class="mt-3"></div>

        <div class="mt-4 flex flex-col md:flex-row gap-2 justify-end actions-mobile">
          <button onclick="generatePDF()" class="btn-primary text-emerald-950 px-5 py-2.5 rounded-xl shadow-sm font-extrabold">Salvar PDF</button>
          <button onclick="saveOfflineHTML()" class="bg-white border border-emerald-200 text-emerald-900 px-5 py-2.5 rounded-xl shadow-sm font-extrabold">Salvar HTML</button>
          <button onclick="restart()" class="btn-secondary text-white px-5 py-2.5 rounded-xl shadow-sm font-extrabold">Nova</button>
        </div>

        <p class="mt-3 text-[11px] text-gray-500" id="autoActionsHint"></p>
        <div class="sig-ui">Rogerio Braga</div>
      </div>
    </div>
  </div>

<script>
"use strict";

const MIN_HEALTHY_PCT = 70;
const MAILTO_TO = "impulsoflow@gmail.com";

const DIMENSIONS = [
  { key:"d1", name:"Autovaloriza√ß√£o e Autoaceita√ß√£o", items:[
    "Sinto que sou uma pessoa de valor, pelo menos tanto quanto outras pessoas.",
    "Consigo reconhecer qualidades em mim, mesmo quando erro.",
    "Aceito que tenho limita√ß√µes sem me diminuir por isso.",
    "Consigo me tratar com respeito, mesmo em dias dif√≠ceis.",
    "Eu me sinto digno(a) de amor e considera√ß√£o.",
    "Eu me reconhe√ßo como algu√©m importante para mim mesmo(a).",
    "Eu me permito ser humano(a), sem me exigir perfei√ß√£o.",
    "Eu consigo separar meu valor pessoal dos meus resultados."
  ]},
  { key:"d2", name:"Autoconfian√ßa e Compet√™ncia Percebida", items:[
    "Eu confio que consigo aprender coisas novas quando necess√°rio.",
    "Eu me considero capaz de lidar com problemas do dia a dia.",
    "Quando falho, consigo tentar de novo sem desistir de mim.",
    "Eu me sinto competente naquilo que fa√ßo na maior parte do tempo.",
    "Eu tomo decis√µes com razo√°vel seguran√ßa.",
    "Eu reconhe√ßo minhas conquistas sem minimiz√°-las.",
    "Eu consigo me posicionar quando preciso.",
    "Eu sinto que tenho recursos internos para enfrentar desafios."
  ]},
  { key:"d3", name:"Autoimagem e Aceita√ß√£o Social", items:[
    "Eu me sinto confort√°vel em ser quem eu sou perto de outras pessoas.",
    "Eu n√£o me comparo o tempo todo de forma que me fa√ßa mal.",
    "Eu consigo receber elogios sem desconfiar ou rejeitar.",
    "Eu me sinto pertencente em ambientes sociais importantes para mim.",
    "Eu consigo dizer ‚Äún√£o‚Äù sem medo excessivo de rejei√ß√£o.",
    "Eu n√£o baseio meu valor apenas na opini√£o dos outros.",
    "Eu me sinto relativamente seguro(a) com minha imagem.",
    "Eu consigo estar em grupo sem me sentir inferior."
  ]},
  { key:"d4", name:"Autocompaix√£o e Di√°logo Interno", items:[
    "Quando erro, eu evito me chamar de nomes ou me humilhar.",
    "Eu consigo me acolher quando estou triste ou frustrado(a).",
    "Eu falo comigo mesmo(a) como falaria com algu√©m que amo.",
    "Eu consigo reconhecer que sofrer faz parte de ser humano.",
    "Eu me permito descansar sem culpa excessiva.",
    "Eu consigo ser firme comigo sem ser cruel.",
    "Eu noto quando meu cr√≠tico interno aparece e consigo ajustar o tom.",
    "Eu consigo me perdoar por escolhas do passado."
  ]},
  { key:"d5", name:"Estabilidade Emocional e Resili√™ncia", items:[
    "Eu consigo me acalmar depois de situa√ß√µes estressantes.",
    "Eu n√£o fico preso(a) por muito tempo em pensamentos autodepreciativos.",
    "Eu consigo pedir ajuda quando preciso.",
    "Eu me recupero relativamente bem ap√≥s cr√≠ticas ou conflitos.",
    "Eu consigo tolerar frustra√ß√£o sem me desorganizar totalmente.",
    "Eu consigo manter esperan√ßa mesmo em fases dif√≠ceis.",
    "Eu reconhe√ßo minhas emo√ß√µes sem ser dominado(a) por elas.",
    "Eu aprendo com dificuldades ao inv√©s de me definir por elas."
  ]}
];

const LIKERT = [
  {v:1, label:"Discordo totalmente"},
  {v:2, label:"Discordo"},
  {v:3, label:"Neutro"},
  {v:4, label:"Concordo"},
  {v:5, label:"Concordo totalmente"}
];

function buildQuestionsShuffled(){
  const arr = [];
  DIMENSIONS.forEach((d, di) => d.items.forEach((text, qi) => arr.push({ di, qi, text })));
  for (let i = arr.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

let user = { name:"", email:"", age:"", occupation:"" };
let questions = [];
let current = 0;
let responses = [];
let chartInstance = null;

function sanitize(s){ return DOMPurify.sanitize(String(s || "")); }
function validateEmail(email){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email); }
function pct(n){ return Math.max(0, Math.min(100, Math.round(n))); }
function todayBR(){ return new Date().toLocaleDateString("pt-BR",{year:"numeric",month:"2-digit",day:"2-digit"}); }
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

function score(){
  const sums = DIMENSIONS.map(()=>0);
  const maxPerDim = 8 * 5;
  for(let i=0;i<questions.length;i++) sums[questions[i].di] += responses[i];
  const pctByDim = sums.map(s => (s / maxPerDim) * 100);
  const iga = pctByDim.reduce((a,b)=>a+b,0) / pctByDim.length;
  return { sums, pctByDim, iga };
}

function igaLevel(igaPct){
  if(igaPct < 35) return "Muito baixo";
  if(igaPct < 55) return "Baixo";
  if(igaPct < 70) return "Moderado";
  if(igaPct < 85) return "Bom";
  return "Excelente";
}

function igaProfile(igaPct){
  if(igaPct < 35) return { title:"üî¥ O Cr√≠tico Interno", text:"Indicador de autocr√≠tica alta e base interna fragilizada. Priorize autocompaix√£o, apoio e reconstru√ß√£o de valor pessoal." };
  if(igaPct < 55) return { title:"üü† O Comparador Inseguro", text:"Oscila√ß√µes e sensibilidade √† valida√ß√£o externa. O foco √© construir consist√™ncia e autonomia emocional." };
  if(igaPct < 70) return { title:"üü° O Realista em Constru√ß√£o", text:"H√° recursos internos, mas eles ficam inst√°veis sob press√£o. Ajustes em h√°bitos e di√°logo interno geram alta evolu√ß√£o." };
  if(igaPct < 85) return { title:"üü¢ O Confiante Equilibrado", text:"Boa base interna e recupera√ß√£o emocional. Reforce rotina e limites para manter estabilidade em fases dif√≠ceis." };
  return { title:"üü£ O Autol√≠der", text:"Autoestima est√°vel, autorregula√ß√£o e clareza de valor. O pr√≥ximo n√≠vel √© consist√™ncia e influ√™ncia positiva em rela√ß√µes/lideran√ßa." };
}

function bandExplain(p){
  if(p < 35) return "Faixa cr√≠tica: tend√™ncia a autodeprecia√ß√£o, vergonha e evita√ß√£o. Pode exigir apoio estruturado.";
  if(p < 55) return "Faixa de risco: autoestima inst√°vel, vulner√°vel a cr√≠ticas/compara√ß√£o. O objetivo √© estabilizar base interna.";
  if(p < 70) return "Faixa intermedi√°ria: voc√™ tem ferramentas, mas n√£o est√£o consistentes. Trabalhar h√°bitos e cren√ßas-chave melhora r√°pido.";
  if(p < 85) return "Faixa saud√°vel: bons recursos e estabilidade. O foco √© refinar e manter o padr√£o sob estresse.";
  return "Faixa √≥tima: padr√£o interno s√≥lido, boa autogest√£o e autorrespeito consistente.";
}

function practicalLine(dimIndex, v, n){
  const name = DIMENSIONS[dimIndex].name;
  const low = v < MIN_HEALTHY_PCT;
  const mid = v >= MIN_HEALTHY_PCT && v < 85;
  if(low){
    const tips = [
      `Priorize 1 h√°bito simples por dia para ${name.toLowerCase()} (consist√™ncia antes de intensidade).`,
      `Reduza gatilhos de autocr√≠tica e adicione um ‚Äúritual de reparo‚Äù ap√≥s erro (ex.: pausa, respira√ß√£o, reframe).`,
      `Busque apoio: conversa orientada + plano semanal de a√ß√µes pequenas (5‚Äì15 min).`
    ];
    return tips[n-1];
  }
  if(mid){
    const tips = [
      `Voc√™ j√° tem base; seu ganho est√° em consist√™ncia sob press√£o.`,
      `Escolha 1 situa√ß√£o recorrente e treine uma resposta nova (script de di√°logo interno/limites/posicionamento).`,
      `Me√ßa evolu√ß√£o: 1 nota semanal (0‚Äì10) para perceber tend√™ncia e n√£o s√≥ ‚Äúo dia‚Äù.`
    ];
    return tips[n-1];
  }
  const tips = [
    `Este √© um ponto forte. Proteja sua rotina e seus limites para manter estabilidade.`,
    `Use esse m√≥dulo como ‚Äú√¢ncora‚Äù para elevar os demais (o que funciona aqui pode ser replicado).`,
    `Ensinar/compartilhar o que voc√™ faz bem consolida o padr√£o interno.`
  ];
  return tips[n-1];
}

/* MAILTO */
function buildMailtoHref(prettyData){
  const to = MAILTO_TO;
  const subject = `Autoestima - ${prettyData.nome}`;
  const bodyLines = [
    "Resultado - Avalia√ß√£o N√≠vel de Autoestima",
    `Nome: ${prettyData.nome}`,
    `Idade: ${prettyData.idade}`,
    `Profiss√£o: ${prettyData.profissao}`,
    `Email: ${prettyData.email}`,
    `IGA: ${prettyData.igaPct}% | N√≠vel: ${prettyData.nivel}`,
    `Perfil: ${prettyData.perfil}`,
    "",
    "M√≥dulos (%):",
    ...prettyData.modulos,
    "",
    `M√≠nimo saud√°vel por m√≥dulo: ${MIN_HEALTHY_PCT}%`,
    "Obs: PDF e HTML foram salvos localmente (downloads no dispositivo)."
  ];
  return "mailto:" + encodeURIComponent(to) + "?subject=" + encodeURIComponent(subject) + "&body=" + encodeURIComponent(bodyLines.join("\n"));
}

function openMailtoByAnchor(mailtoHref){
  const a = document.createElement("a");
  a.setAttribute("href", mailtoHref);
  a.style.display = "none";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

function ensureMailtoFallbackLink(mailtoHref){
  const host = document.getElementById("mailtoFallbackHost");
  if(!host) return;
  let fallback = document.getElementById("mailto-fallback");
  if(!fallback){
    fallback = document.createElement("a");
    fallback.id = "mailto-fallback";
    fallback.textContent = "Se o e-mail n√£o abriu (iPhone), toque aqui para abrir e enviar";
    fallback.href = mailtoHref;
    fallback.style.display = "inline-block";
    fallback.style.marginTop = "10px";
    fallback.style.padding = "12px 16px";
    fallback.style.borderRadius = "12px";
    fallback.style.textDecoration = "none";
    fallback.style.background = "#10b981";
    fallback.style.color = "#064e3b";
    fallback.style.fontWeight = "800";
    fallback.style.cursor = "pointer";
    fallback.style.border = "1px solid rgba(16,185,129,.25)";
    fallback.style.boxShadow = "0 6px 18px rgba(2,6,23,.08)";
    host.appendChild(fallback);
  } else {
    fallback.href = mailtoHref;
    fallback.style.display = "inline-block";
  }
}

function startTest(){
  const name = document.getElementById("name").value.trim();
  const email = document.getElementById("email").value.trim();
  const age = document.getElementById("age").value.trim();
  const occupation = document.getElementById("occupation").value.trim();
  const ageNum = Number(age);
  if(!name || !email || !validateEmail(email) || !age || !occupation || !Number.isFinite(ageNum) || ageNum < 10 || ageNum > 100){
    alert("Preencha Nome, Email, Idade (10‚Äì100) e Profiss√£o corretamente.");
    return;
  }
  user = { name, email, age: String(ageNum), occupation };
  questions = buildQuestionsShuffled();
  responses = new Array(questions.length).fill(null);
  current = 0;
  document.getElementById("intro").classList.add("hidden");
  document.getElementById("test").classList.remove("hidden");
  renderQuestion();
}

function renderQuestion(){
  const total = questions.length;
  const qNum = current + 1;
  const progress = Math.round(((qNum - 1) / total) * 100);
  const q = questions[current];

  document.getElementById("questionHost").innerHTML = `
    <div class="bg-white/70 border border-emerald-100 rounded-xl p-4">
      <div class="mb-3">
        <div class="flex items-center justify-between gap-2">
          <p class="text-xs font-extrabold text-gray-600">Progresso</p>
          <p class="text-xs font-extrabold text-gray-600">${qNum}/${total}</p>
        </div>
        <div class="progress-rail mt-2"><div class="progress-fill" style="width:${progress}%"></div></div>
      </div>

      <p class="question-text text-xl md:text-2xl font-normal text-center text-gray-900 leading-snug">
        "${sanitize(q.text)}"
      </p>

      <div class="scale-grid grid grid-cols-5 gap-2 mt-5">
        ${LIKERT.map(opt => `
          <div class="scale-option ${responses[current]===opt.v?'selected':''}" onclick="selectAnswer(${opt.v})">
            <div class="text-base">${opt.v}</div>
            <small class="text-[10px] font-semibold">${sanitize(opt.label)}</small>
          </div>
        `).join("")}
      </div>

      <div class="actions-mobile flex flex-col md:flex-row items-center justify-center gap-2 mt-5">
        <button onclick="prev()" class="px-5 py-2.5 rounded-xl font-extrabold border border-gray-200 bg-white text-gray-700 ${current===0?'opacity-40 cursor-not-allowed':''}" ${current===0?'disabled':''}>Anterior</button>
        ${current < total-1
          ? `<button onclick="next()" class="btn-primary text-emerald-950 px-6 py-2.5 rounded-xl shadow-sm font-extrabold ${responses[current]===null?'opacity-50 cursor-not-allowed':''}">Pr√≥xima</button>`
          : `<button onclick="finish()" class="btn-primary text-emerald-950 px-6 py-2.5 rounded-xl shadow-sm font-extrabold ${responses[current]===null?'opacity-50 cursor-not-allowed':''}">Ver resultado</button>`
        }
      </div>
    </div>
  `;
}

function selectAnswer(v){ responses[current] = v; renderQuestion(); }
function next(){ if(responses[current] === null){ alert("Selecione uma op√ß√£o antes de continuar."); return; } current++; renderQuestion(); }
function prev(){ if(current===0) return; current--; renderQuestion(); }

function renderAlerts(pctByDim){
  const low = pctByDim.map((v,i)=>({v:Math.round(v), i})).filter(x=>x.v < MIN_HEALTHY_PCT);
  const wrap = document.getElementById("alerts");
  if(low.length === 0){ wrap.classList.add("hidden"); wrap.innerHTML = ""; return; }
  wrap.classList.remove("hidden");
  wrap.className = "mt-4 space-y-2";
  wrap.innerHTML = low.map(x => `
    <div class="bg-amber-50 border border-amber-200 rounded-xl p-3">
      <p class="text-sm font-extrabold text-amber-900">Alerta: abaixo do m√≠nimo saud√°vel</p>
      <p class="text-xs text-amber-900 mt-1"><span class="font-bold">${sanitize(DIMENSIONS[x.i].name)}</span> ‚Äî ${x.v}% (m√≠nimo saud√°vel: ${MIN_HEALTHY_PCT}%).</p>
      <p class="text-xs text-amber-800 mt-1">Interpreta√ß√£o: ${sanitize(bandExplain(x.v))}</p>
    </div>
  `).join("");
}

function renderThemesChart(pctByDim){
  document.getElementById("minHealthyLabel").textContent = `${MIN_HEALTHY_PCT}%`;
  const labels = DIMENSIONS.map(d=>d.name);
  const data = pctByDim.map(v=>Math.round(v));
  const ctx = document.getElementById("themesChart").getContext("2d");
  Chart.register(ChartDataLabels);
  if(chartInstance){ chartInstance.destroy(); chartInstance = null; }

  chartInstance = new Chart(ctx, {
    type:"bar",
    data:{ labels, datasets:[{ data,
      backgroundColor: data.map(v => v < MIN_HEALTHY_PCT ? "rgba(245,158,11,0.55)" : "rgba(16,185,129,0.55)"),
      borderColor: data.map(v => v < MIN_HEALTHY_PCT ? "rgba(217,119,6,1)" : "rgba(5,150,105,1)"),
      borderWidth: 1, borderRadius: 10, borderSkipped: false
    }]},
    options:{
      indexAxis:"y", responsive:true, maintainAspectRatio:false,
      scales:{
        x:{ beginAtZero:true, max:100, ticks:{ stepSize:10, color:"#374151", font:{ size:11 } }, grid:{ color:"rgba(0,0,0,0.06)" } },
        y:{ ticks:{ color:"#111827", font:{ size:12, weight:"bold" } }, grid:{ display:false } }
      },
      plugins:{ legend:{ display:false }, datalabels:{ anchor:"end", align:"right", formatter:(v)=> `${v}%`, color:"#065f46", font:{ weight:"bold", size:13 }, offset: 8 } }
    },
    plugins: [{
      id: "minHealthyLine",
      afterDraw(chart){
        const {ctx, chartArea, scales} = chart;
        const x = scales.x.getPixelForValue(MIN_HEALTHY_PCT);
        ctx.save();
        ctx.strokeStyle = "rgba(245,158,11,0.95)";
        ctx.lineWidth = 2;
        ctx.setLineDash([6,6]);
        ctx.beginPath();
        ctx.moveTo(x, chartArea.top);
        ctx.lineTo(x, chartArea.bottom);
        ctx.stroke();
        ctx.setLineDash([]);
        ctx.fillStyle = "rgba(180,83,9,1)";
        ctx.font = "bold 11px Inter, Arial";
        ctx.fillText(`m√≠n. saud√°vel ${MIN_HEALTHY_PCT}%`, x + 6, chartArea.top + 14);
        ctx.restore();
      }
    }]
  });
}

function moduleDetailHTML(pctByDim){
  return pctByDim.map((p, i) => {
    const v = Math.round(p);
    const status = v < MIN_HEALTHY_PCT ? "Aten√ß√£o" : "OK";
    const badgeClass = v < MIN_HEALTHY_PCT ? "bg-amber-100 text-amber-900 border-amber-200" : "bg-emerald-100 text-emerald-900 border-emerald-200";
    return `
      <div class="border border-gray-100 rounded-xl p-3 bg-gray-50">
        <div class="flex items-start justify-between gap-2">
          <div>
            <p class="text-sm font-extrabold text-gray-900">${sanitize(DIMENSIONS[i].name)}</p>
            <p class="text-xs text-gray-700 mt-1">${sanitize(bandExplain(v))}</p>
          </div>
          <div class="shrink-0">
            <span class="text-xs font-extrabold px-2 py-1 rounded-full border ${badgeClass}">${status} ‚Ä¢ ${v}%</span>
          </div>
        </div>
        <div class="mt-2 text-xs text-gray-700">
          <p class="font-bold">Leitura pr√°tica:</p>
          <ul class="list-disc list-inside mt-1 space-y-1">
            <li>${sanitize(practicalLine(i, v, 1))}</li>
            <li>${sanitize(practicalLine(i, v, 2))}</li>
            <li>${sanitize(practicalLine(i, v, 3))}</li>
          </ul>
        </div>
      </div>
    `;
  }).join("");
}

/* iPhone fix: abre mailto primeiro */
async function finish(){
  if(responses[current] === null){ alert("Selecione uma op√ß√£o antes de continuar."); return; }
  if(responses.some(r => r === null)){ alert("Responda todas as perguntas."); return; }

  const s = score();
  const igaPct = pct(s.iga);
  const level = igaLevel(igaPct);
  const profile = igaProfile(igaPct);

  document.getElementById("test").classList.add("hidden");
  document.getElementById("result").classList.remove("hidden");

  document.getElementById("personalData").innerHTML =
    `<span class="font-bold">Nome:</span> ${sanitize(user.name)} | ` +
    `<span class="font-bold">Idade:</span> ${sanitize(user.age)} | ` +
    `<span class="font-bold">Profiss√£o:</span> ${sanitize(user.occupation)} | ` +
    `<span class="font-bold">Email:</span> ${sanitize(user.email)}`;

  document.getElementById("igaPct").textContent = `${igaPct}%`;
  document.getElementById("igaLevel").textContent = `N√≠vel: ${level}`;
  document.getElementById("profileTitle").textContent = profile.title;
  document.getElementById("profileText").textContent = profile.text;

  window._igaData = { user, igaPct, level, profile, pctByDim: s.pctByDim };

  renderAlerts(s.pctByDim);
  renderThemesChart(s.pctByDim);
  document.getElementById("moduleExplain").innerHTML = moduleDetailHTML(s.pctByDim);

  const prettyData = {
    nome: user.name,
    idade: user.age,
    profissao: user.occupation,
    email: user.email,
    igaPct: igaPct,
    nivel: level,
    perfil: profile.title,
    modulos: s.pctByDim.map((v,i)=> `- ${DIMENSIONS[i].name}: ${Math.round(v)}%`)
  };

  const mailtoHref = buildMailtoHref(prettyData);
  ensureMailtoFallbackLink(mailtoHref);

  const hint = document.getElementById("autoActionsHint");
  hint.textContent = "Abrindo o e-mail agora‚Ä¶ Se n√£o abrir, use o bot√£o verde de fallback. Depois, geraremos PDF/HTML.";

  try{ openMailtoByAnchor(mailtoHref); }catch(e){ console.error(e); }

  setTimeout(async () => {
    try{ await generatePDF(true); }catch(e){ console.error(e); }
    setTimeout(() => {
      try{ saveOfflineHTML(true); }catch(e){ console.error(e); }
      hint.textContent = "Se PDF/HTML n√£o baixarem automaticamente (iPhone), use os bot√µes ‚ÄúSalvar PDF‚Äù e ‚ÄúSalvar HTML‚Äù.";
    }, 700);
  }, 700);
}

/* PARTE 2/2 CONTINUA: generatePDF + saveOfflineHTML + restart */
</script>
</body>
</html>async function generatePDF(silent=false){
  try{
    const data = window._igaData;
    if(!data){ if(!silent) alert("Gere o resultado antes de salvar PDF."); return; }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ format:"a4" });

    const pageW = 210, pageH = 297;
    const margin = 14;
    const boxW = pageW - margin*2;

    function setBody(){ doc.setFont("helvetica","normal"); doc.setFontSize(10); doc.setTextColor(31,41,55); }
    function setTitle(){ doc.setFont("helvetica","bold"); doc.setFontSize(18); doc.setTextColor(20,83,45); }
    function setSection(){ doc.setFont("helvetica","bold"); doc.setFontSize(12); doc.setTextColor(20,83,45); }
    function box(x,y,w,h){ doc.setDrawColor(16,185,129); doc.setLineWidth(0.35); doc.setFillColor(255,255,255); doc.roundedRect(x,y,w,h,3,3,"FD"); }
    function addSignatureFooter(){
      doc.setFont("helvetica","normal");
      doc.setFontSize(8);
      doc.setTextColor(30,64,175);
      doc.text("Rogerio Braga", pageW - margin, pageH - 10, { align:"right" });
      doc.setTextColor(31,41,55);
    }
    function safePageBreak(currentY, needed){
      if(currentY + needed <= 270) return false;
      addSignatureFooter();
      doc.addPage();
      doc.setFillColor(246,253,248);
      doc.rect(0,0,pageW,pageH,"F");
      doc.setFont("helvetica","bold");
      doc.setFontSize(14);
      doc.setTextColor(20,83,45);
      doc.text("Detalhamento por m√≥dulos (continua√ß√£o)", pageW/2, 18, { align:"center" });
      setBody();
      return true;
    }

    // P√°gina 1
    doc.setFillColor(246,253,248);
    doc.rect(0,0,pageW,pageH,"F");

    setTitle();
    doc.text("Avalia√ß√£o N√≠vel de Autoestima", pageW/2, 18, { align:"center" });
    setBody();
    doc.text(`Data: ${todayBR()}`, pageW - margin, 26, { align:"right" });

    let y = 32;

    // Dados do participante (compacto)
    box(margin, y, boxW, 30);
    setSection();
    doc.text("Dados do Participante", margin + 6, y + 9);
    setBody();
    const u = data.user || {};
    doc.text(`Nome: ${u.name || ""}`, margin + 6, y + 17);
    doc.text(`Email: ${u.email || ""}`, margin + 6, y + 24);
    doc.text(`Idade: ${u.age || ""}`, margin + 120, y + 17);
    doc.text(`Profiss√£o: ${u.occupation || ""}`, margin + 120, y + 24);
    y += 38;

    // Mini-dashboard
    const dashH = 60;
    box(margin, y, boxW, dashH);
    setSection();
    doc.text("Mini-dashboard", margin + 6, y + 9);

    const igaPctNum = Number(data.igaPct ?? 0);
    const pctByDim = Array.isArray(data.pctByDim) ? data.pctByDim.map(v=>Math.round(v)) : [];
    const anyLow = pctByDim.some(v => v < MIN_HEALTHY_PCT);

    doc.setFont("helvetica","bold");
    doc.setFontSize(26);
    doc.setTextColor(5,150,105);
    doc.text(`${igaPctNum}%`, margin + 6, y + 30);

    doc.setFont("helvetica","bold");
    doc.setFontSize(11);
    doc.setTextColor(31,41,55);
    doc.text(`IGA: ${data.level || ""}`, margin + 46, y + 20);

    doc.setFont("helvetica","normal");
    doc.setFontSize(10);
    doc.text(doc.splitTextToSize(`Perfil: ${(data.profile && data.profile.title) ? data.profile.title : ""}`, 110), margin + 46, y + 28);

    // Selo OK/ATEN√á√ÉO
    const sealText = anyLow ? "ATEN√á√ÉO" : "OK";
    const sealFill = anyLow ? [255,237,213] : [220,252,231];
    const sealStroke = anyLow ? [249,115,22] : [16,185,129];
    const sealW = 44, sealH = 14;
    const sealX = margin + boxW - sealW - 6;
    const sealY = y + 14;

    doc.setDrawColor(sealStroke[0], sealStroke[1], sealStroke[2]);
    doc.setFillColor(sealFill[0], sealFill[1], sealFill[2]);
    doc.roundedRect(sealX, sealY, sealW, sealH, 6, 6, "FD");
    doc.setFont("helvetica","bold");
    doc.setFontSize(10);
    doc.setTextColor(31,41,55);
    doc.text(sealText, sealX + sealW/2, sealY + 9.5, { align:"center" });

    // Mini-barras
    const barsX = margin + 46;
    const barsY = y + 40;
    const barW = boxW - (barsX - margin) - 6;
    const barH = 4;
    const gap = 7;

    doc.setFont("helvetica","bold");
    doc.setFontSize(9);
    doc.setTextColor(55,65,81);

    for(let i=0;i<DIMENSIONS.length;i++){
      const label = DIMENSIONS[i].name;
      const v = Math.round(clamp(pctByDim[i] ?? 0, 0, 100));
      const rowY = barsY + i*gap;

      const short = label.length > 28 ? label.slice(0,28) + "‚Ä¶" : label;
      doc.text(short, barsX, rowY);

      const trackX = barsX + 60;
      const trackY = rowY - 3.2;
      const trackW = barW - 80;

      doc.setDrawColor(229,231,235);
      doc.setFillColor(229,231,235);
      doc.roundedRect(trackX, trackY, trackW, barH, 2, 2, "F");

      const isLow = v < MIN_HEALTHY_PCT;
      const fill = isLow ? [245,158,11] : [16,185,129];
      doc.setFillColor(fill[0], fill[1], fill[2]);
      doc.roundedRect(trackX, trackY, (trackW * v)/100, barH, 2, 2, "F");

      doc.setFont("helvetica","bold");
      doc.setFontSize(9);
      doc.setTextColor(isLow ? 180 : 6, isLow ? 83 : 95, isLow ? 9 : 70);
      doc.text(`${v}%`, trackX + trackW + 6, rowY);
      doc.setTextColor(55,65,81);
    }

    y += dashH + 8;

    // Gr√°fico grande
    const chartCanvas = document.getElementById("themesChart");
    if(chartCanvas){
      const shot = await html2canvas(chartCanvas, { scale: 3, backgroundColor: "#ffffff" });
      const img = shot.toDataURL("image/png", 1.0);
      doc.addImage(img, "PNG", margin, y, boxW, 88);
      y += 96;
    }

    addSignatureFooter();

    // P√°gina 2: detalhes
    doc.addPage();
    doc.setFillColor(246,253,248);
    doc.rect(0,0,pageW,pageH,"F");

    doc.setFont("helvetica","bold");
    doc.setFontSize(14);
    doc.setTextColor(20,83,45);
    doc.text("Detalhamento por m√≥dulos", pageW/2, 18, { align:"center" });

    setBody();
    y = 28;

    const lows = pctByDim.map((v,i)=>({v, i})).filter(x=>x.v < MIN_HEALTHY_PCT);
    if(lows.length){
      doc.setFont("helvetica","bold");
      doc.setFontSize(12);
      doc.setTextColor(180,83,9);
      doc.text("Alertas (abaixo do m√≠nimo saud√°vel)", margin, y);
      y += 7;

      setBody();
      lows.forEach((x)=>{
        const line = `‚Ä¢ ${DIMENSIONS[x.i].name}: ${x.v}% (m√≠n.: ${MIN_HEALTHY_PCT}%) ‚Äî ${bandExplain(x.v)}`;
        const wrapped = doc.splitTextToSize(line, boxW);
        safePageBreak(y, wrapped.length*5 + 4);
        doc.text(wrapped, margin, y);
        y += wrapped.length * 5 + 2;
      });

      y += 4;
    }

    (data.pctByDim || []).forEach((v,i)=>{
      const vv = Math.round(v);
      const status = vv < MIN_HEALTHY_PCT ? "ABAIXO do m√≠nimo saud√°vel" : "OK";

      doc.setFont("helvetica","bold");
      doc.setTextColor(31,41,55);

      const head = `${DIMENSIONS[i].name}: ${vv}% (${status})`;
      const headLines = doc.splitTextToSize(head, boxW);
      safePageBreak(y, headLines.length*5 + 6);
      doc.text(headLines, margin, y);
      y += headLines.length*5 + 2;

      doc.setFont("helvetica","normal");
      const expl = `Interpreta√ß√£o: ${bandExplain(vv)}`;
      const explLines = doc.splitTextToSize(expl, boxW);
      safePageBreak(y, explLines.length*5 + 6);
      doc.text(explLines, margin, y);
      y += explLines.length * 5 + 2;

      const tips = `Leitura pr√°tica: ‚Ä¢ ${practicalLine(i, vv, 1)} ‚Ä¢ ${practicalLine(i, vv, 2)} ‚Ä¢ ${practicalLine(i, vv, 3)}`;
      const tipsLines = doc.splitTextToSize(tips, boxW);
      safePageBreak(y, tipsLines.length*5 + 10);
      doc.text(tipsLines, margin, y);
      y += tipsLines.length * 5 + 6;
    });

    addSignatureFooter();

    const pdfName = `Autoestima_${sanitize(data.user.name).replace(/\s+/g,"_")}.pdf`;
    doc.save(pdfName);

  }catch(e){
    console.error(e);
    if(!silent) alert("Erro ao gerar PDF.");
  }
}

function saveOfflineHTML(silent=false){
  const data = window._igaData;
  if(!data){ if(!silent) alert("Gere o resultado antes de salvar HTML."); return; }

  const chartCanvas = document.getElementById("themesChart");
  let chartImgData = "";
  if(chartCanvas) chartImgData = chartCanvas.toDataURL("image/png", 1.0);

  const resultClone = document.querySelector("#result").cloneNode(true);

  // Canvas -> img
  const oldCanvas = resultClone.querySelector("#themesChart");
  if(oldCanvas && chartImgData){
    const img = document.createElement("img");
    img.src = chartImgData;
    img.alt = "Gr√°fico por m√≥dulos";
    img.style.width = "100%";
    img.style.maxWidth = "920px";
    img.style.height = "auto";
    img.style.display = "block";
    img.style.margin = "0 auto";
    oldCanvas.parentNode.replaceChild(img, oldCanvas);
  }

  // remove bot√µes
  const btns = resultClone.querySelectorAll("button");
  btns.forEach(b => b.remove());

  // assinatura no HTML salvo
  const sig = document.createElement("div");
  sig.className = "sig";
  sig.textContent = "Rogerio Braga";
  resultClone.appendChild(sig);

  const styleContent = `
    <style>
      body{ font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#fff; margin:0; padding:20px; }
      .container{ max-width: 920px; margin:0 auto; }
      .sig{ font-family: "Dancing Script", cursive; color:#1d4ed8; font-size:12px; text-align:right; margin-top:18px; opacity:.9; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet" />
  `;

  const htmlContent = `
    <!DOCTYPE html>
    <html lang="pt-BR">
    <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>Resultado Autoestima ‚Äî ${sanitize(data.user.name)}</title>
      ${styleContent}
    </head>
    <body>
      <div class="container">
        ${resultClone.outerHTML}
      </div>
    </body>
    </html>
  `;

  const blob = new Blob([htmlContent], { type:"text/html;charset=utf-8" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `Resultado_Autoestima_${sanitize(data.user.name).replace(/\s+/g,"_")}.html`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);

  URL.revokeObjectURL(url);
}

function restart(){
  questions = [];
  responses = [];
  current = 0;
  window._igaData = null;

  if(chartInstance){ chartInstance.destroy(); chartInstance = null; }

  document.getElementById("alerts").classList.add("hidden");
  document.getElementById("alerts").innerHTML = "";
  document.getElementById("moduleExplain").innerHTML = "";
  document.getElementById("autoActionsHint").textContent = "";

  const fb = document.getElementById("mailto-fallback");
  if(fb) fb.remove();

  document.getElementById("result").classList.add("hidden");
  document.getElementById("test").classList.add("hidden");
  document.getElementById("intro").classList.remove("hidden");

  document.getElementById("name").value = "";
  document.getElementById("email").value = "";
  document.getElementById("age").value = "";
  document.getElementById("occupation").value = "";
}
